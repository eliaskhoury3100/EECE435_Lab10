pipeline {
  agent any

  environment {
    VENV = '.venv'
    PYTHON = 'python3'
  }

  options { timestamps() }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Setup') {
      steps {
        sh """
          set -e
          if [ ! -d "${VENV}" ]; then ${PYTHON} -m venv ${VENV}; fi
          . ${VENV}/bin/activate
          pip install --upgrade pip
          # Install project deps (if any) + CI tools
          [ -f requirements.txt ] && pip install -r requirements.txt || true
          pip install flake8 pytest coverage bandit
        """
      }
    }

    stage('Lint') {
      steps {
        sh """
          . ${VENV}/bin/activate
          flake8 app.py
        """
      }
    }

    stage('Test') {
      steps {
        sh """
          . ${VENV}/bin/activate
          mkdir -p test-results
          # Set PYTHONPATH to repo root so tests can import app.py
          PYTHONPATH="$PWD" pytest -v --tb=short --junitxml=test-results/pytest.xml
        """
      }
    }

    stage('Coverage') {
      steps {
        sh """
          . ${VENV}/bin/activate
          PYTHONPATH="$PWD" coverage run -m pytest -q
          coverage report -m
          coverage xml -o coverage.xml
        """
      }
    }

    stage('Security Scan') {
      steps {
        sh """
          . ${VENV}/bin/activate
          bandit -r app.py -f txt -o bandit.txt || true
        """
      }
    }

    stage('Deploy (local)') {
      when { expression { fileExists('deploy.sh') } } // only if you add a Unix script
      steps {
        sh """
          . ${VENV}/bin/activate
          bash ./deploy.sh
        """
      }
    }
  }

  post {
    always {
      junit allowEmptyResults: true, testResults: 'test-results/*.xml'
      archiveArtifacts artifacts: 'coverage.xml, bandit.txt', allowEmptyArchive: true
      cleanWs()
    }
  }
}